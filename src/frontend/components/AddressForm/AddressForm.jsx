import { SERVICE_TYPES, ToastType, COUNTRY_CODES } from '../../constants/constants';
import { useConfigContext } from '../../contexts/ConfigContextProvider';
import { useCurrencyContext } from '../../contexts/CurrencyContextProvider';
import { useAllProductsContext } from '../../contexts/ProductsContextProvider';
import { useState, useEffect } from 'react';
import { v4 as uuid } from 'uuid';
import FormRow from '../FormRow';
import Price from '../Price';
import styles from './AddressForm.module.css';
import {
  toastHandler,
  validateEmptyTextInput,
} from '../../utils/utils';

const AddressForm = ({ isAdding, isEditingAndData = null, closeForm }) => {
  const { addAddressDispatch, timedMainPageLoader, editAddressDispatch, cart } =
    useAllProductsContext();

  const { storeConfig } = useConfigContext();
  const { formatPrice } = useCurrencyContext();
  const SANTIAGO_ZONES = storeConfig.zones || [];

  const isEditing = !!isEditingAndData;

  // FUNCI√ìN MEJORADA PARA VERIFICAR ENV√çO DISPONIBLE CON SINCRONIZACI√ìN EN TIEMPO REAL
  const hasShippingAvailableInCart = () => {
    // 1. Obtener productos actualizados desde localStorage (configuraci√≥n del admin)
    const savedConfig = localStorage.getItem('adminStoreConfig');
    let adminProducts = [];
    
    if (savedConfig) {
      try {
        const parsedConfig = JSON.parse(savedConfig);
        adminProducts = parsedConfig.products || [];
      } catch (error) {
        console.error('Error al cargar productos del admin:', error);
      }
    }

    // 2. Verificar cada producto en el carrito
    return cart.some(cartItem => {
      // Extraer el ID del producto (sin el color)
      const productId = cartItem._id.split('#')[0] || cartItem._id;
      
      // Buscar el producto en la configuraci√≥n del admin (datos m√°s actualizados)
      const adminProduct = adminProducts.find(p => p._id === productId);
      
      // Si encontramos el producto en la configuraci√≥n del admin, usar esos datos
      if (adminProduct) {
        console.log(`üîç Producto ${adminProduct.name}: env√≠o disponible = ${adminProduct.isShippingAvailable}`);
        return adminProduct.isShippingAvailable === true;
      }
      
      // Si no est√° en la configuraci√≥n del admin, usar los datos del carrito
      console.log(`‚ö†Ô∏è Producto ${cartItem.name}: usando datos del carrito = ${cartItem.isShippingAvailable}`);
      return cartItem.isShippingAvailable === true;
    });
  };

  // ESTADO REACTIVO PARA DETECTAR CAMBIOS EN TIEMPO REAL
  const [canUseHomeDelivery, setCanUseHomeDelivery] = useState(false);

  // EFECTO PARA ACTUALIZAR EL ESTADO CUANDO CAMBIE EL CARRITO O LA CONFIGURACI√ìN
  useEffect(() => {
    const updateShippingAvailability = () => {
      const hasShipping = hasShippingAvailableInCart();
      console.log(`üöö Actualizaci√≥n de env√≠o disponible: ${hasShipping}`);
      setCanUseHomeDelivery(hasShipping);
    };

    // Actualizar inmediatamente
    updateShippingAvailability();

    // Escuchar eventos de actualizaci√≥n de productos
    const handleProductsUpdate = () => {
      console.log('üì° Evento de actualizaci√≥n de productos detectado en AddressForm');
      setTimeout(updateShippingAvailability, 100); // Peque√±o delay para asegurar que los datos est√©n actualizados
    };

    const handleConfigUpdate = () => {
      console.log('üì° Evento de actualizaci√≥n de configuraci√≥n detectado en AddressForm');
      setTimeout(updateShippingAvailability, 100);
    };

    // Agregar listeners para eventos de sincronizaci√≥n
    window.addEventListener('productsUpdated', handleProductsUpdate);
    window.addEventListener('productsConfigUpdated', handleProductsUpdate);
    window.addEventListener('forceStoreUpdate', handleConfigUpdate);
    window.addEventListener('adminConfigChanged', handleConfigUpdate);

    // Cleanup
    return () => {
      window.removeEventListener('productsUpdated', handleProductsUpdate);
      window.removeEventListener('productsConfigUpdated', handleProductsUpdate);
      window.removeEventListener('forceStoreUpdate', handleConfigUpdate);
      window.removeEventListener('adminConfigChanged', handleConfigUpdate);
    };
  }, [cart, hasShippingAvailableInCart]); // Dependencia del carrito para reaccionar a cambios

  const defaultState = {
    username: '',
    mobile: '',
    countryCode: '+53', // Cuba por defecto
    serviceType: canUseHomeDelivery ? SERVICE_TYPES.HOME_DELIVERY : SERVICE_TYPES.PICKUP,
    zone: '',
    addressInfo: '',
    receiverName: '',
    receiverPhone: '',
    receiverCountryCode: '+53', // Cuba por defecto
    additionalInfo: '',
  };

  const [inputs, setInputs] = useState(
    isEditing ? {
      ...isEditingAndData,
      countryCode: isEditingAndData.countryCode || '+53',
      receiverCountryCode: isEditingAndData.receiverCountryCode || '+53'
    } : defaultState
  );

  // ACTUALIZAR EL TIPO DE SERVICIO CUANDO CAMBIE LA DISPONIBILIDAD DE ENV√çO
  useEffect(() => {
    if (!isEditing && !canUseHomeDelivery && inputs.serviceType === SERVICE_TYPES.HOME_DELIVERY) {
      setInputs(prev => ({
        ...prev,
        serviceType: SERVICE_TYPES.PICKUP
      }));
    }
  }, [canUseHomeDelivery, isEditing, inputs.serviceType]);

  const [mobileValidation, setMobileValidation] = useState({
    isValid: true,
    message: ''
  });

  const [receiverPhoneValidation, setReceiverPhoneValidation] = useState({
    isValid: true,
    message: ''
  });

  // Funci√≥n para validar n√∫mero m√≥vil
  const validateMobileNumber = (countryCode, number) => {
    const country = COUNTRY_CODES.find(c => c.code === countryCode);
    if (!country) return { isValid: false, message: 'C√≥digo de pa√≠s no v√°lido' };

    const cleanNumber = number.replace(/\D/g, '');
    
    if (cleanNumber.length < country.minLength) {
      return { 
        isValid: false, 
        message: `N√∫mero muy corto. M√≠nimo ${country.minLength} d√≠gitos para ${country.country}` 
      };
    }
    
    if (cleanNumber.length > country.maxLength) {
      return { 
        isValid: false, 
        message: `N√∫mero muy largo. M√°ximo ${country.maxLength} d√≠gitos para ${country.country}` 
      };
    }

    return { isValid: true, message: '' };
  };

  const handleInputChange = (e) => {
    const targetEle = e.target;
    const targetEleName = targetEle.name;
    let elementValue = targetEle.value;

    if (targetEle.type === 'number') {
      elementValue = isNaN(targetEle.valueAsNumber)
        ? ''
        : targetEle.valueAsNumber;
    }

    setInputs({
      ...inputs,
      [targetEleName]: elementValue,
    });

    // Validar n√∫meros m√≥viles en tiempo real
    if (targetEleName === 'mobile' || targetEleName === 'countryCode') {
      const validation = validateMobileNumber(
        targetEleName === 'countryCode' ? elementValue : inputs.countryCode,
        targetEleName === 'mobile' ? elementValue : inputs.mobile
      );
      setMobileValidation(validation);
    }

    if (targetEleName === 'receiverPhone' || targetEleName === 'receiverCountryCode') {
      const validation = validateMobileNumber(
        targetEleName === 'receiverCountryCode' ? elementValue : inputs.receiverCountryCode,
        targetEleName === 'receiverPhone' ? elementValue : inputs.receiverPhone
      );
      setReceiverPhoneValidation(validation);
    }
  };

  const handleSubmitForm = async (e) => {
    e.preventDefault();

    // Validaciones seg√∫n el tipo de servicio
    let requiredFields = ['username', 'mobile', 'serviceType'];
    
    if (inputs.serviceType === SERVICE_TYPES.HOME_DELIVERY) {
      requiredFields = [...requiredFields, 'zone', 'addressInfo', 'receiverName', 'receiverPhone'];
    }

    // Validar campos requeridos
    for (const field of requiredFields) {
      if (!inputs[field] || (typeof inputs[field] === 'string' && !inputs[field].trim())) {
        toastHandler(ToastType.Error, 'Por favor completa todos los campos obligatorios');
        return;
      }
    }

    // Validar n√∫meros m√≥viles
    if (!mobileValidation.isValid) {
      toastHandler(ToastType.Error, `N√∫mero m√≥vil inv√°lido: ${mobileValidation.message}`);
      return;
    }

    if (inputs.serviceType === SERVICE_TYPES.HOME_DELIVERY && !receiverPhoneValidation.isValid) {
      toastHandler(ToastType.Error, `Tel√©fono del receptor inv√°lido: ${receiverPhoneValidation.message}`);
      return;
    }

    await timedMainPageLoader();

    const addressData = {
      ...inputs,
      addressId: isEditing ? isEditingAndData.addressId : uuid(),
      mobile: `${inputs.countryCode} ${inputs.mobile}`,
      receiverPhone: inputs.receiverPhone ? `${inputs.receiverCountryCode} ${inputs.receiverPhone}` : '',
      deliveryCost: inputs.serviceType === SERVICE_TYPES.HOME_DELIVERY 
        ? SANTIAGO_ZONES.find(zone => zone.id === inputs.zone)?.cost || 0
        : 0
    };

    if (isAdding) {
      addAddressDispatch(addressData);
    }

    if (isEditing) {
      editAddressDispatch(addressData);
    }

    closeForm();
  };

  const handleReset = () => {
    setInputs(defaultState);
    setMobileValidation({ isValid: true, message: '' });
    setReceiverPhoneValidation({ isValid: true, message: '' });
  };

  const isHomeDelivery = inputs.serviceType === SERVICE_TYPES.HOME_DELIVERY;
  const selectedCountry = COUNTRY_CODES.find(c => c.code === inputs.countryCode);
  const selectedReceiverCountry = COUNTRY_CODES.find(c => c.code === inputs.receiverCountryCode);

  return (
    <div className={styles.formOverlay}>
      <form
        onClick={(e) => e.stopPropagation()}
        className={styles.form}
        onSubmit={handleSubmitForm}
      >
        <div className={styles.formHeader}>
          <h3>{isEditing ? 'Editar Direcci√≥n' : 'Nueva Direcci√≥n'}</h3>
          <button type="button" className={styles.closeBtn} onClick={closeForm}>
            ‚úï
          </button>
        </div>

        <div className={styles.formContent}>
          <FormRow
            text='Nombre Completo'
            type='text'
            name='username'
            id='username'
            placeholder='Tu nombre completo'
            value={inputs.username}
            handleChange={handleInputChange}
          />

          <div className={styles.formGroup}>
            <label htmlFor='mobile'>üì± N√∫mero de M√≥vil *</label>
            <div className={styles.phoneContainer}>
              <select
                name='countryCode'
                value={inputs.countryCode}
                onChange={handleInputChange}
                className={styles.countrySelect}
                required
              >
                {COUNTRY_CODES.map(country => (
                  <option key={country.code} value={country.code}>
                    {country.flag} {country.code} {country.country}
                  </option>
                ))}
              </select>
              <input
                type='tel'
                name='mobile'
                id='mobile'
                placeholder='N√∫mero m√≥vil'
                value={inputs.mobile}
                onChange={handleInputChange}
                className={`form-input ${!mobileValidation.isValid ? styles.invalidInput : ''}`}
                required
              />
            </div>
            {selectedCountry && (
              <div className={styles.countryInfo}>
                <span className={styles.flag}>{selectedCountry.flag}</span>
                <span>{selectedCountry.country} - {selectedCountry.minLength}-{selectedCountry.maxLength} d√≠gitos</span>
              </div>
            )}
            {!mobileValidation.isValid && (
              <div className={styles.errorMessage}>{mobileValidation.message}</div>
            )}
          </div>

          <div className={styles.formGroup}>
            <label htmlFor='serviceType'>üöö Tipo de Servicio *</label>
            <div className={styles.serviceTypeContainer}>
              <div className={styles.serviceOption}>
                <input
                  type="radio"
                  id="homeDelivery"
                  name="serviceType"
                  value={SERVICE_TYPES.HOME_DELIVERY}
                  checked={inputs.serviceType === SERVICE_TYPES.HOME_DELIVERY}
                  onChange={handleInputChange}
                  disabled={!canUseHomeDelivery}
                />
                <label htmlFor="homeDelivery" className={!canUseHomeDelivery ? styles.disabledOption : ''}>
                  üöö Entrega a domicilio
                  {!canUseHomeDelivery && (
                    <span className={styles.lockIcon}>üîí</span>
                  )}
                </label>
              </div>
              <div className={styles.serviceOption}>
                <input
                  type="radio"
                  id="pickup"
                  name="serviceType"
                  value={SERVICE_TYPES.PICKUP}
                  checked={inputs.serviceType === SERVICE_TYPES.PICKUP}
                  onChange={handleInputChange}
                />
                <label htmlFor="pickup">
                  üè™ Pedido para recoger en el local
                </label>
              </div>
            </div>
            {!canUseHomeDelivery && (
              <div className={styles.shippingWarning}>
                <span>‚ö†Ô∏è Los productos en tu carrito no tienen env√≠o disponible. Solo puedes recoger en el local.</span>
                <small>üí° Los cambios del panel de administraci√≥n se aplican en tiempo real</small>
              </div>
            )}
          </div>

          {isHomeDelivery ? (
            <div className={styles.deliverySection}>
              <div className={styles.formGroup}>
                <label htmlFor='zone'>üìç ¬øD√≥nde la entregamos? - Selecciona la zona de tu direcci√≥n *</label>
                <select
                  className='form-select'
                  name='zone'
                  id='zone'
                  onChange={handleInputChange}
                  value={inputs.zone}
                  required
                >
                  <option value='' disabled>
                    Selecciona tu zona en Santiago de Cuba:
                  </option>
                  {SANTIAGO_ZONES.map((zone) => (
                    <option key={zone.id} value={zone.id}>
                      {zone.name} - <Price amount={zone.cost} />
                    </option>
                  ))}
                </select>
              </div>

              <div className={styles.formGroup}>
                <label htmlFor='addressInfo'>üè† Direcci√≥n Completa *</label>
                <textarea
                  name='addressInfo'
                  id='addressInfo'
                  className='form-textarea'
                  placeholder='Direcci√≥n completa (calle, n√∫mero, entre calles, referencias, etc.)'
                  value={inputs.addressInfo}
                  onChange={handleInputChange}
                  required
                />
              </div>

              <FormRow
                text='üë§ ¬øQui√©n recibe el pedido? *'
                type='text'
                name='receiverName'
                id='receiverName'
                placeholder='Nombre de quien recibe'
                value={inputs.receiverName}
                handleChange={handleInputChange}
              />

              <div className={styles.formGroup}>
                <label htmlFor='receiverPhone'>üìû Tel√©fono de quien recibe *</label>
                <div className={styles.phoneContainer}>
                  <select
                    name='receiverCountryCode'
                    value={inputs.receiverCountryCode}
                    onChange={handleInputChange}
                    className={styles.countrySelect}
                    required
                  >
                    {COUNTRY_CODES.map(country => (
                      <option key={country.code} value={country.code}>
                        {country.flag} {country.code} {country.country}
                      </option>
                    ))}
                  </select>
                  <input
                    type='tel'
                    name='receiverPhone'
                    id='receiverPhone'
                    placeholder='Tel√©fono del receptor'
                    value={inputs.receiverPhone}
                    onChange={handleInputChange}
                    className={`form-input ${!receiverPhoneValidation.isValid ? styles.invalidInput : ''}`}
                    required
                  />
                </div>
                {selectedReceiverCountry && (
                  <div className={styles.countryInfo}>
                    <span className={styles.flag}>{selectedReceiverCountry.flag}</span>
                    <span>{selectedReceiverCountry.country} - {selectedReceiverCountry.minLength}-{selectedReceiverCountry.maxLength} d√≠gitos</span>
                  </div>
                )}
                {!receiverPhoneValidation.isValid && (
                  <div className={styles.errorMessage}>{receiverPhoneValidation.message}</div>
                )}
              </div>
            </div>
          ) : (
            <div className={styles.formGroup}>
              <label htmlFor='additionalInfo'>üí¨ ¬øQuieres aclararnos algo?</label>
              <textarea
                name='additionalInfo'
                id='additionalInfo'
                className='form-textarea'
                placeholder='Informaci√≥n adicional sobre tu pedido (opcional)'
                value={inputs.additionalInfo}
                onChange={handleInputChange}
              />
            </div>
          )}
        </div>

        <div className={styles.formBtnContainer}>
          <button 
            type='submit' 
            className={`btn btn-primary ${styles.primaryButton}`}
            disabled={!mobileValidation.isValid || (isHomeDelivery && !receiverPhoneValidation.isValid)}
          >
            {isEditing ? '‚úÖ Actualizar' : '‚ûï Agregar'}
          </button>

          <div className={styles.secondaryButtons}>
            <button onClick={handleReset} type='button' className='btn btn-hipster'>
              üîÑ Restablecer
            </button>

            <button type='button' className='btn btn-danger' onClick={closeForm}>
              ‚ùå Cancelar
            </button>
          </div>
        </div>
      </form>
    </div>
  );
};

export default AddressForm;